"use strict";var O=Object.create;var m=Object.defineProperty,L=Object.defineProperties,C=Object.getOwnPropertyDescriptor,q=Object.getOwnPropertyDescriptors,x=Object.getOwnPropertyNames,g=Object.getOwnPropertySymbols,b=Object.getPrototypeOf,w=Object.prototype.hasOwnProperty,v=Object.prototype.propertyIsEnumerable;var T=(t,s,e)=>s in t?m(t,s,{enumerable:!0,configurable:!0,writable:!0,value:e}):t[s]=e,R=(t,s)=>{for(var e in s||(s={}))w.call(s,e)&&T(t,e,s[e]);if(g)for(var e of g(s))v.call(s,e)&&T(t,e,s[e]);return t},N=(t,s)=>L(t,q(s));var G=(t,s)=>{for(var e in s)m(t,e,{get:s[e],enumerable:!0})},f=(t,s,e,o)=>{if(s&&typeof s=="object"||typeof s=="function")for(let r of x(s))!w.call(t,r)&&r!==e&&m(t,r,{get:()=>s[r],enumerable:!(o=C(s,r))||o.enumerable});return t};var _=(t,s,e)=>(e=t!=null?O(b(t)):{},f(s||!t||!t.__esModule?m(e,"default",{value:t,enumerable:!0}):e,t)),H=t=>f(m({},"__esModule",{value:!0}),t);var p=(t,s,e)=>new Promise((o,r)=>{var a=n=>{try{c(e.next(n))}catch(d){r(d)}},i=n=>{try{c(e.throw(n))}catch(d){r(d)}},c=n=>n.done?o(n.value):Promise.resolve(n.value).then(a,i);c((e=e.apply(t,s)).next())});var D={};G(D,{UsersController:()=>l});module.exports=H(D);var M=require("jsonwebtoken"),E=require("bcrypt");var F=require("dotenv/config"),U={jwt:{secret:process.env.JWT_STRING||"default",expiresIn:"365d"}};var Y=require("dotenv/config"),h=_(require("mysql2")),j=h.default.createPool({host:process.env.MYSQL_HOST,user:process.env.MYSQL_USER,database:process.env.MYSQL_DATABASE,password:process.env.MYSQL_PASSWORD,waitForConnections:!0,connectionLimit:10,maxIdle:10,idleTimeout:6e4,queueLimit:0,enableKeepAlive:!0,keepAliveInitialDelay:0,charset:"utf8mb4"}),u=j.promise();var S=({error:t=!1,message:s="OPERA\xC7\xC3O EXECUTADA COM SUCESSO.",path:e,data:o,code:r=200})=>({code:r,error:t,message:s.toUpperCase(),path:e.toUpperCase(),data:o});var I=class{static signIn(s,e){return p(this,null,function*(){let[o]=yield u.query("SELECT * FROM users AS u WHERE u.email = ?",[s]),r=o[0];if(r){let[a]=yield u.query("SELECT * FROM establishments AS e WHERE e.id = ?",[r==null?void 0:r.id]),i=a[0];if(!(0,E.compareSync)(e,r==null?void 0:r.password))return S({code:401,error:!0,path:"USERSENTITIES:SIGNIN",message:"E-MAIL OU SENHA INV\xC1LIDOS.",data:{}});delete r.password,delete r.recover_password;let n=N(R({},r),{establishmentId:i==null?void 0:i.id}),{secret:d,expiresIn:y}=U.jwt,A=(0,M.sign)({user:JSON.stringify(n)},d,{expiresIn:y});return S({path:"USERSENTITIES:SIGNIN",data:{dataUser:n,token:A}})}else return S({code:401,error:!0,path:"USERSENTITIES:SIGNIN",message:"Email e/ou senha incorretos",data:[]})})}static signUp(s,e){return p(this,null,function*(){let[o]=yield u.query("SELECT U.email FROM users AS U WHERE U.email = ? LIMIT 1",[s]);if(o[0]!=null)return S({code:406,error:!0,path:"USERSENTITIES:SIGNIN",message:"Esse E-mail j\xE1 est\xE1 cadastrado no sistemas.",data:{}});{let a=(0,E.genSaltSync)(10),i=(0,E.hashSync)(e,a),[c]=yield u.query("INSERT INTO users (email,password) VALUES (?,?);",[s,i]);return S({path:"USERSENTITIES:SIGNIN",data:{rows:c}})}})}};var l=class{static signIn(s,e){return p(this,null,function*(){let{email:o,password:r}=s.body,a=yield I.signIn(o,r);return e.status(a.code).json(a)})}static signUp(s,e){return p(this,null,function*(){let{email:o,password:r}=s.body,a=yield I.signUp(o,r);return e.status(a.code).json(a)})}};0&&(module.exports={UsersController});
