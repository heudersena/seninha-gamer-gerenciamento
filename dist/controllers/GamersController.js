"use strict";var D=Object.create;var g=Object.defineProperty;var q=Object.getOwnPropertyDescriptor;var v=Object.getOwnPropertyNames;var G=Object.getPrototypeOf,Y=Object.prototype.hasOwnProperty;var j=(a,t)=>{for(var e in t)g(a,e,{get:t[e],enumerable:!0})},I=(a,t,e,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let o of v(t))!Y.call(a,o)&&o!==e&&g(a,o,{get:()=>t[o],enumerable:!(n=q(t,o))||n.enumerable});return a};var f=(a,t,e)=>(e=a!=null?D(G(a)):{},I(t||!a||!a.__esModule?g(e,"default",{value:a,enumerable:!0}):e,a)),k=a=>I(g({},"__esModule",{value:!0}),a);var i=(a,t,e)=>new Promise((n,o)=>{var m=s=>{try{p(e.next(s))}catch(u){o(u)}},d=s=>{try{p(e.throw(s))}catch(u){o(u)}},p=s=>s.done?n(s.value):Promise.resolve(s.value).then(m,d);p((e=e.apply(a,t)).next())});var Q={};j(Q,{GamersController:()=>S});module.exports=k(Q);var _=({error:a=!1,message:t="OPERA\xC7\xC3O EXECUTADA COM SUCESSO.",path:e,data:n,code:o=200})=>({code:o,error:a,message:t.toUpperCase(),path:e.toUpperCase(),data:n});var J=require("dotenv/config"),O=f(require("mysql2")),H=O.default.createPool({host:process.env.MYSQL_HOST,user:process.env.MYSQL_USER,database:process.env.MYSQL_DATABASE,password:process.env.MYSQL_PASSWORD,waitForConnections:!0,connectionLimit:10,maxIdle:10,idleTimeout:6e4,queueLimit:0,enableKeepAlive:!0,keepAliveInitialDelay:0,charset:"utf8mb4"}),c=H.promise();var l=class{static index(){return i(this,null,function*(){try{let[t]=yield c.query("SELECT * FROM games");return _({path:"GAMESENTITIES:INDEX",data:{rows:t}})}catch(t){return _({error:!0,path:"GAMESENTITIES:INDEX",message:JSON.stringify(t),data:{}})}})}static gameGenerator(t,e){return i(this,null,function*(){try{let[n]=yield c.query("CALL PROCEDURE_REGISTRAR_JOGOS(?,?,?)",[t,25,e]);return n[0]}catch(n){return _({error:!0,path:"GAMESENTITIES:gameGenerator",message:JSON.stringify(n),data:{}})}})}};var N=require("uuid");var z=require("dotenv/config"),y=f(require("mercadopago")),T=f(require("dayjs"));y.default.configurations.setAccessToken(String(process.env.MERCADO_PAGO_KEY_PROD));var E=class{static createPayment(t){return i(this,null,function*(){var o;let e={transaction_amount:t.transaction_amount,payment_method_id:"pix",payer:{email:t.payer.email},installments:1,date_of_expiration:String((0,T.default)(new Date).add(10,"minutes").format("YYYY-MM-DDTHH:mm:ss.000ZZ"))};return yield(o=y.default.payment)==null?void 0:o.save(e)})}static GetPayment(t){return i(this,null,function*(){return yield y.default.payment.findById(t)})}};function C(a){return i(this,null,function*(){let[t]=yield c.query("SELECT * FROM bets WHERE code_cart=?",[a]);return t})}var S=class{static index(t,e){return i(this,null,function*(){let n=yield l.index();e.json(n)})}static create(t,e){return i(this,null,function*(){try{let n=(0,N.v4)(),o=t.body.quantities?t.body.quantities<=10?t.body.quantities:12:1,m=t.body.type_pagamento;if(console.log(m),t.user.establishmentId==null)return e.status(401).json(_({error:!0,code:401,data:{},path:"GamersController:create",message:"voc\xEA ainda n\xE3o possui instabelecimento registrado."}));let d=Number(t.user.establishmentId);for(let r=0;r<o;r++)yield l.gameGenerator(d,n);let p=yield C(n),s=o*2,u=s*30/100,P=s*70/100;if(m=="pix"){let r=yield E.createPayment({transaction_amount:s,payment_method_id:"debit_card",payer:{email:t.user.email},installments:1}),A=r.response.id,U=r.response.status,L=r.response.status_detail,M=r.response.payer.email,h=r.response.point_of_interaction.transaction_data.qr_code,w=r.response.point_of_interaction.transaction_data.ticket_url,b=r.response.transaction_details.transaction_id,R=r.response.point_of_interaction.transaction_data.qr_code_base64,[x]=yield c.query("CALL PROCEDURE_INSERT_TRANSACTION(?,?,?,?,?,?,?,?,?,?,?)",[s,m,A,U,L,M,h,w,b,R,d]);return t.io.emit("ATUALIZAR::VALORES::MOEDA",{}),e.json({mercadopago:{id:A,status_detail:L,transaction_id:b,qr_code_base64:R,email:M},code:n,apostas:p,transaction:x[0][0]})}else{let[r]=yield c.query("CALL PROCEDURE_INSERT_TRANSACTION(?,?,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,?)",[P,m,d]);return t.io.emit("ATUALIZAR::VALORES::MOEDA",{}),e.json({mercadopago:{},apostas:p,transaction:r[0][0]})}}catch(n){return e.json({mercadopago:{},apostas:{},transaction:{},error:n})}})}};0&&(module.exports={GamersController});
