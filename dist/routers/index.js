"use strict";var ot=Object.create;var I=Object.defineProperty,at=Object.defineProperties,nt=Object.getOwnPropertyDescriptor,it=Object.getOwnPropertyDescriptors,ct=Object.getOwnPropertyNames,W=Object.getOwnPropertySymbols,mt=Object.getPrototypeOf,J=Object.prototype.hasOwnProperty,pt=Object.prototype.propertyIsEnumerable;var F=(o,t,e)=>t in o?I(o,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):o[t]=e,V=(o,t)=>{for(var e in t||(t={}))J.call(t,e)&&F(o,e,t[e]);if(W)for(var e of W(t))pt.call(t,e)&&F(o,e,t[e]);return o},Y=(o,t)=>at(o,it(t));var ut=(o,t)=>{for(var e in t)I(o,e,{get:t[e],enumerable:!0})},B=(o,t,e,s)=>{if(t&&typeof t=="object"||typeof t=="function")for(let r of ct(t))!J.call(o,r)&&r!==e&&I(o,r,{get:()=>t[r],enumerable:!(s=nt(t,r))||s.enumerable});return o};var j=(o,t,e)=>(e=o!=null?ot(mt(o)):{},B(t||!o||!o.__esModule?I(e,"default",{value:o,enumerable:!0}):e,o)),dt=o=>B(I({},"__esModule",{value:!0}),o);var a=(o,t,e)=>new Promise((s,r)=>{var n=m=>{try{c(e.next(m))}catch(l){r(l)}},i=m=>{try{c(e.throw(m))}catch(l){r(l)}},c=m=>m.done?s(m.value):Promise.resolve(m.value).then(n,i);c((e=e.apply(o,t)).next())});var _t={};ut(_t,{router:()=>_});module.exports=dt(_t);var tt=require("express");var Q=require("jsonwebtoken"),g=require("bcrypt");var St=require("dotenv/config"),O={jwt:{secret:process.env.JWT_STRING||"default",expiresIn:"365d"}};var Rt=require("dotenv/config"),$=j(require("mysql2")),lt=$.default.createPool({host:process.env.MYSQL_HOST,user:process.env.MYSQL_USER,database:process.env.MYSQL_DATABASE,password:process.env.MYSQL_PASSWORD,waitForConnections:!0,connectionLimit:10,maxIdle:10,idleTimeout:6e4,queueLimit:0,enableKeepAlive:!0,keepAliveInitialDelay:0,charset:"utf8mb4"}),p=lt.promise();var d=({error:o=!1,message:t="OPERA\xC7\xC3O EXECUTADA COM SUCESSO.",path:e,data:s,code:r=200})=>({code:r,error:o,message:t.toUpperCase(),path:e.toUpperCase(),data:s});var f=class{static signIn(t,e){return a(this,null,function*(){let[s]=yield p.query("SELECT * FROM users AS u WHERE u.email = ?",[t]),r=s[0];if(r){let[n]=yield p.query("SELECT * FROM establishments AS e WHERE e.id = ?",[r==null?void 0:r.id]),i=n[0];if(!(0,g.compareSync)(e,r==null?void 0:r.password))return d({code:401,error:!0,path:"USERSENTITIES:SIGNIN",message:"E-MAIL OU SENHA INV\xC1LIDOS.",data:{}});delete r.password,delete r.recover_password;let m=Y(V({},r),{establishmentId:i==null?void 0:i.id}),{secret:l,expiresIn:E}=O.jwt,u=(0,Q.sign)({user:JSON.stringify(m)},l,{expiresIn:E});return d({path:"USERSENTITIES:SIGNIN",data:{dataUser:m,token:u}})}else return d({code:401,error:!0,path:"USERSENTITIES:SIGNIN",message:"Email e/ou senha incorretos",data:[]})})}static signUp(t,e){return a(this,null,function*(){let[s]=yield p.query("SELECT U.email FROM users AS U WHERE U.email = ? LIMIT 1",[t]);if(s[0]!=null)return d({code:406,error:!0,path:"USERSENTITIES:SIGNIN",message:"Esse E-mail j\xE1 est\xE1 cadastrado no sistemas.",data:{}});{let n=(0,g.genSaltSync)(10),i=(0,g.hashSync)(e,n),[c]=yield p.query("INSERT INTO users (email,password) VALUES (?,?);",[t,i]);return d({path:"USERSENTITIES:SIGNIN",data:{rows:c}})}})}};var T=class{static signIn(t,e){return a(this,null,function*(){let{email:s,password:r}=t.body,n=yield f.signIn(s,r);return e.status(n.code).json(n)})}static signUp(t,e){return a(this,null,function*(){let{email:s,password:r}=t.body,n=yield f.signUp(s,r);return e.status(n.code).json(n)})}};var A=class{static index(){return a(this,null,function*(){try{let[t]=yield p.query("SELECT * FROM games");return d({path:"GAMESENTITIES:INDEX",data:{rows:t}})}catch(t){return d({error:!0,path:"GAMESENTITIES:INDEX",message:JSON.stringify(t),data:{}})}})}static gameGenerator(t,e){return a(this,null,function*(){try{let[s]=yield p.query("CALL PROCEDURE_REGISTRAR_JOGOS(?,?,?)",[t,25,e]);return s[0]}catch(s){return d({error:!0,path:"GAMESENTITIES:gameGenerator",message:JSON.stringify(s),data:{}})}})}};var K=require("uuid");var Pt=require("dotenv/config"),M=j(require("mercadopago")),X=j(require("dayjs"));M.default.configurations.setAccessToken(String(process.env.MERCADO_PAGO_KEY_PROD));var S=class{static createPayment(t){return a(this,null,function*(){var r;let e={transaction_amount:t.transaction_amount,payment_method_id:"pix",payer:{email:t.payer.email},installments:1,date_of_expiration:String((0,X.default)(new Date).add(10,"minutes").format("YYYY-MM-DDTHH:mm:ss.000ZZ"))};return yield(r=M.default.payment)==null?void 0:r.save(e)})}static GetPayment(t){return a(this,null,function*(){return yield M.default.payment.findById(t)})}};function Z(o){return a(this,null,function*(){let[t]=yield p.query("SELECT * FROM bets WHERE code_cart=?",[o]);return t})}var h=class{static index(t,e){return a(this,null,function*(){let s=yield A.index();e.json(s)})}static create(t,e){return a(this,null,function*(){try{let s=(0,K.v4)(),r=t.body.quantities?t.body.quantities<=10?t.body.quantities:12:1,n=t.body.type_pagamento;if(console.log(n),t.user.establishmentId==null)return e.status(401).json(d({error:!0,code:401,data:{},path:"GamersController:create",message:"voc\xEA ainda n\xE3o possui instabelecimento registrado."}));let i=Number(t.user.establishmentId);for(let u=0;u<r;u++)yield A.gameGenerator(i,s);let c=yield Z(s),m=r*2,l=m*30/100,E=m*70/100;if(n=="pix"){let u=yield S.createPayment({transaction_amount:m,payment_method_id:"debit_card",payer:{email:t.user.email},installments:1}),b=u.response.id,N=u.response.status,y=u.response.status_detail,D=u.response.payer.email,et=u.response.point_of_interaction.transaction_data.qr_code,st=u.response.point_of_interaction.transaction_data.ticket_url,H=u.response.transaction_details.transaction_id,k=u.response.point_of_interaction.transaction_data.qr_code_base64,[rt]=yield p.query("CALL PROCEDURE_INSERT_TRANSACTION(?,?,?,?,?,?,?,?,?,?,?)",[m,n,b,N,y,D,et,st,H,k,i]);return t.io.emit("ATUALIZAR::VALORES::MOEDA",{}),e.json({mercadopago:{id:b,status_detail:y,transaction_id:H,qr_code_base64:k,email:D},code:s,apostas:c,transaction:rt[0][0]})}else{let[u]=yield p.query("CALL PROCEDURE_INSERT_TRANSACTION(?,?,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,?)",[E,n,i]);return t.io.emit("ATUALIZAR::VALORES::MOEDA",{}),e.json({mercadopago:{},apostas:c,transaction:u[0][0]})}}catch(s){return e.json({mercadopago:{},apostas:{},transaction:{},error:s})}})}};var z=require("jsonwebtoken");var R=(o,t,e)=>a(void 0,null,function*(){let s=o.headers.authorization;if(!s)return t.status(401).json("JWT n\xE3o informado");let[,r]=s.split(" ");try{let n=(0,z.verify)(r,O.jwt.secret);return o.user=JSON.parse(n.user),e()}catch(n){return t.status(401).json("JWT Token invalido")}});var C=class{static seekContestWinners(t,e){return a(this,null,function*(){return Promise.all([yield p.query("CALL PROCEDURE_BUSCAR_GANHADORES_POR_ESTABELECIMENTO_E_CONCURSO(?,?)",[t,e]),yield p.query("CALL PROCEDURE_BUSCAR_VALORES_A_SER_PAGO(?)",[e])])})}};var w=class{static search_concurso(t,e){return a(this,null,function*(){try{let{concurso:s}=t.body,r=t.user.establishmentId,n=yield C.seekContestWinners(Number(r),Number(s)),i=n[0][0][0],c=n[1][0][0],m=d({data:{_pagamento:c,_concursos:i},path:"BetsController:search_concurso"});return e.json(m)}catch(s){let r=d({error:!0,code:400,message:JSON.stringify(s),data:{},path:"BetsController:search_concurso"});return e.json(r)}})}};var L=class{static addMoneyOnMatch(t){return a(this,null,function*(){var n,i,c;let[e]=yield p.query("SELECT * FROM VIEW_VERIFICAR_SE_EXISTE_PAGAMENTO_IN_PROCESSO;"),s=yield S.createPayment({transaction_amount:t,payment_method_id:"debit_card",payer:{email:"heuderdev@gmail.com"},installments:1});if(console.log(JSON.stringify(s,null,2)),((n=e[0])==null?void 0:n.id)!=null){let[m]=yield p.query("SELECT * FROM TB_ACUMULA_VALORES_CASO_AWARDS_DIFERENTE_IN_PROCESSING WHERE id = 1;"),l=Number((i=e[0])==null?void 0:i.subtract_premiums),E=l+t;console.log(Number((c=m[0])==null?void 0:c.amount)),console.log(l),console.log(E)}else console.log("RECURSO EM PROCESSO.");return{}})}};var U=class{static add(t,e){return a(this,null,function*(){let s=yield L.addMoneyOnMatch(1);return e.json(s)})}};var P=class{static checkPayment(t,e){return a(this,null,function*(){try{let s=Number(t.body.id),r=yield S.GetPayment(s),n=r.response.status_detail,i=r.response.status,[c]=yield p.query("UPDATE transactions AS T SET m_status= ?, m_status_detail=? WHERE m_id =? ",[i,n,s]);return e.json({id:r.response.transaction_details.transaction_id})}catch(s){return e.json({id:{},error:s})}})}static webhook(t,e){return a(this,null,function*(){})}};var q=class{static create(t,e,s,r,n,i,c,m,l,E){return a(this,null,function*(){try{let[u]=yield p.query("INSERT INTO adresses (cep, state, city, neighborhood, street, number, geographic_location, latitude, longitude, establishmentId) VALUES (?,?,?,?,?,?,?,?,?,?)",[t,e,s,r,n,i,c,m,l,E]);return d({path:"ADRESSESENTITIES::CREATE::TRY",data:{createdAdresses:u}})}catch(u){return d({error:!0,code:400,path:"ADRESSESENTITIES::CREATE::CATCH",data:{},message:JSON.stringify(u,null,2)})}})}};var x=class{static create(t,e){return a(this,null,function*(){var s;try{let{cep:r,state:n,city:i,neighborhood:c,street:m,number:l,geographic_location:E,latitude:u,longitude:b}=t.body,N=(s=t.user)==null?void 0:s.establishmentId;console.log(t.body,N);let y=yield q.create(r,n,i,c,m,l,E,u,b,N);return e.status(y.code).json(y)}catch(r){return e.status(400).json(r)}})}};var G=class{static create(t,e,s,r,n,i){return a(this,null,function*(){try{let[c]=yield p.query("INSERT INTO establishments (name, userId, seller_code, number_phone, number_code, description) VALUES (?,?,?,?,?,?)",[t,e,s,r,n,i]);return d({path:"ESTABLISHMENTSENTITIES::CREATE::TRY",data:{createdEstablishement:c}})}catch(c){return d({error:!0,code:400,path:"ESTABLISHMENTSENTITIES::CREATE::CATCH",data:{},message:JSON.stringify(c,null,2)})}})}};var v=class{static create(t,e){return a(this,null,function*(){try{let{name:s,userId:r,seller_code:n,number_phone:i,number_code:c,description:m}=t.body;console.log(`INSERT INTO establishments (name, userId, seller_code, number_phone, number_code, description) VALUES (${s}, ${r}, ${n}, ${i}, ${c}, ${m}) `);let l=yield G.create(s,r,n,i,c,m);return e.status(l.code).json(l)}catch(s){return e.status(400).json(s)}})}};var _=(0,tt.Router)();_.post("/v1/users/signin",T.signIn);_.post("/v1/users/signup",T.signUp);_.get("/v1/games",h.index);_.post("/v1/games/create",R,h.create);_.post("/v1/bets",R,w.search_concurso);_.post("/v1/awards/add-money",U.add);_.post("/v1/verify-payment",R,P.checkPayment);_.post("/v1/adresses",R,x.create);_.post("/v1/establishment",R,v.create);0&&(module.exports={router});
