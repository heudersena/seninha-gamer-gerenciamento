"use strict";var pt=Object.create;var j=Object.defineProperty,ut=Object.defineProperties,dt=Object.getOwnPropertyDescriptor,lt=Object.getOwnPropertyDescriptors,Et=Object.getOwnPropertyNames,V=Object.getOwnPropertySymbols,_t=Object.getPrototypeOf,B=Object.prototype.hasOwnProperty,St=Object.prototype.propertyIsEnumerable;var Y=(o,t,e)=>t in o?j(o,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):o[t]=e,k=(o,t)=>{for(var e in t||(t={}))B.call(t,e)&&Y(o,e,t[e]);if(V)for(var e of V(t))St.call(t,e)&&Y(o,e,t[e]);return o},$=(o,t)=>ut(o,lt(t));var Rt=(o,t,e,s)=>{if(t&&typeof t=="object"||typeof t=="function")for(let r of Et(t))!B.call(o,r)&&r!==e&&j(o,r,{get:()=>t[r],enumerable:!(s=dt(t,r))||s.enumerable});return o};var R=(o,t,e)=>(e=o!=null?pt(_t(o)):{},Rt(t||!o||!o.__esModule?j(e,"default",{value:o,enumerable:!0}):e,o));var n=(o,t,e)=>new Promise((s,r)=>{var a=m=>{try{c(e.next(m))}catch(l){r(l)}},i=m=>{try{c(e.throw(m))}catch(l){r(l)}},c=m=>m.done?s(m.value):Promise.resolve(m.value).then(a,i);c((e=e.apply(o,t)).next())});var Je=require("dotenv/config"),H=R(require("express")),st=R(require("http")),rt=R(require("cors")),ot=require("socket.io");var et=require("express");var X=require("jsonwebtoken"),g=require("bcrypt");var It=require("dotenv/config"),M={jwt:{secret:process.env.JWT_STRING||"default",expiresIn:"365d"}};var Tt=require("dotenv/config"),Q=R(require("mysql2")),gt=Q.default.createPool({host:process.env.MYSQL_HOST,user:process.env.MYSQL_USER,database:process.env.MYSQL_DATABASE,password:process.env.MYSQL_PASSWORD,waitForConnections:!0,connectionLimit:10,maxIdle:10,idleTimeout:6e4,queueLimit:0,enableKeepAlive:!0,keepAliveInitialDelay:0,charset:"utf8mb4"}),p=gt.promise();var d=({error:o=!1,message:t="OPERA\xC7\xC3O EXECUTADA COM SUCESSO.",path:e,data:s,code:r=200})=>({code:r,error:o,message:t.toUpperCase(),path:e.toUpperCase(),data:s});var f=class{static signIn(t,e){return n(this,null,function*(){let[s]=yield p.query("SELECT * FROM users AS u WHERE u.email = ?",[t]),r=s[0];if(r){let[a]=yield p.query("SELECT * FROM establishments AS e WHERE e.id = ?",[r==null?void 0:r.id]),i=a[0];if(!(0,g.compareSync)(e,r==null?void 0:r.password))return d({code:401,error:!0,path:"USERSENTITIES:SIGNIN",message:"E-MAIL OU SENHA INV\xC1LIDOS.",data:{}});delete r.password,delete r.recover_password;let m=$(k({},r),{establishmentId:i==null?void 0:i.id}),{secret:l,expiresIn:_}=M.jwt,u=(0,X.sign)({user:JSON.stringify(m)},l,{expiresIn:_});return d({path:"USERSENTITIES:SIGNIN",data:{dataUser:m,token:u}})}else return d({code:401,error:!0,path:"USERSENTITIES:SIGNIN",message:"Email e/ou senha incorretos",data:[]})})}static signUp(t,e){return n(this,null,function*(){let[s]=yield p.query("SELECT U.email FROM users AS U WHERE U.email = ? LIMIT 1",[t]);if(s[0]!=null)return d({code:406,error:!0,path:"USERSENTITIES:SIGNIN",message:"Esse E-mail j\xE1 est\xE1 cadastrado no sistemas.",data:{}});{let a=(0,g.genSaltSync)(10),i=(0,g.hashSync)(e,a),[c]=yield p.query("INSERT INTO users (email,password) VALUES (?,?);",[t,i]);return d({path:"USERSENTITIES:SIGNIN",data:{rows:c}})}})}};var T=class{static signIn(t,e){return n(this,null,function*(){let{email:s,password:r}=t.body,a=yield f.signIn(s,r);return e.status(a.code).json(a)})}static signUp(t,e){return n(this,null,function*(){let{email:s,password:r}=t.body,a=yield f.signUp(s,r);return e.status(a.code).json(a)})}};var A=class{static index(){return n(this,null,function*(){try{let[t]=yield p.query("SELECT * FROM games");return d({path:"GAMESENTITIES:INDEX",data:{rows:t}})}catch(t){return d({error:!0,path:"GAMESENTITIES:INDEX",message:JSON.stringify(t),data:{}})}})}static gameGenerator(t,e){return n(this,null,function*(){try{let[s]=yield p.query("CALL PROCEDURE_REGISTRAR_JOGOS(?,?,?)",[t,25,e]);return s[0]}catch(s){return d({error:!0,path:"GAMESENTITIES:gameGenerator",message:JSON.stringify(s),data:{}})}})}};var z=require("uuid");var Gt=require("dotenv/config"),C=R(require("mercadopago")),Z=R(require("dayjs"));C.default.configurations.setAccessToken(String(process.env.MERCADO_PAGO_KEY_PROD));var S=class{static createPayment(t){return n(this,null,function*(){var r;let e={transaction_amount:t.transaction_amount,payment_method_id:"pix",payer:{email:t.payer.email},installments:1,date_of_expiration:String((0,Z.default)(new Date).add(10,"minutes").format("YYYY-MM-DDTHH:mm:ss.000ZZ"))};return yield(r=C.default.payment)==null?void 0:r.save(e)})}static GetPayment(t){return n(this,null,function*(){return yield C.default.payment.findById(t)})}};function K(o){return n(this,null,function*(){let[t]=yield p.query("SELECT * FROM bets WHERE code_cart=?",[o]);return t})}var h=class{static index(t,e){return n(this,null,function*(){let s=yield A.index();e.json(s)})}static create(t,e){return n(this,null,function*(){try{let s=(0,z.v4)(),r=t.body.quantities?t.body.quantities<=10?t.body.quantities:12:1,a=t.body.type_pagamento;if(console.log(a),t.user.establishmentId==null)return e.status(401).json(d({error:!0,code:401,data:{},path:"GamersController:create",message:"voc\xEA ainda n\xE3o possui instabelecimento registrado."}));let i=Number(t.user.establishmentId);for(let u=0;u<r;u++)yield A.gameGenerator(i,s);let c=yield K(s),m=r*2,l=m*30/100,_=m*70/100;if(a=="pix"){let u=yield S.createPayment({transaction_amount:m,payment_method_id:"debit_card",payer:{email:t.user.email},installments:1}),b=u.response.id,O=u.response.status,I=u.response.status_detail,F=u.response.payer.email,it=u.response.point_of_interaction.transaction_data.qr_code,ct=u.response.point_of_interaction.transaction_data.ticket_url,W=u.response.transaction_details.transaction_id,J=u.response.point_of_interaction.transaction_data.qr_code_base64,[mt]=yield p.query("CALL PROCEDURE_INSERT_TRANSACTION(?,?,?,?,?,?,?,?,?,?,?)",[m,a,b,O,I,F,it,ct,W,J,i]);return t.io.emit("ATUALIZAR::VALORES::MOEDA",{}),e.json({mercadopago:{id:b,status_detail:I,transaction_id:W,qr_code_base64:J,email:F},code:s,apostas:c,transaction:mt[0][0]})}else{let[u]=yield p.query("CALL PROCEDURE_INSERT_TRANSACTION(?,?,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,?)",[_,a,i]);return t.io.emit("ATUALIZAR::VALORES::MOEDA",{}),e.json({mercadopago:{},apostas:c,transaction:u[0][0]})}}catch(s){return e.json({mercadopago:{},apostas:{},transaction:{},error:s})}})}};var tt=require("jsonwebtoken");var y=(o,t,e)=>n(void 0,null,function*(){let s=o.headers.authorization;if(!s)return t.status(401).json("JWT n\xE3o informado");let[,r]=s.split(" ");try{let a=(0,tt.verify)(r,M.jwt.secret);return o.user=JSON.parse(a.user),e()}catch(a){return t.status(401).json("JWT Token invalido")}});var w=class{static seekContestWinners(t,e){return n(this,null,function*(){return Promise.all([yield p.query("CALL PROCEDURE_BUSCAR_GANHADORES_POR_ESTABELECIMENTO_E_CONCURSO(?,?)",[t,e]),yield p.query("CALL PROCEDURE_BUSCAR_VALORES_A_SER_PAGO(?)",[e])])})}};var L=class{static search_concurso(t,e){return n(this,null,function*(){try{let{concurso:s}=t.body,r=t.user.establishmentId,a=yield w.seekContestWinners(Number(r),Number(s)),i=a[0][0][0],c=a[1][0][0],m=d({data:{_pagamento:c,_concursos:i},path:"BetsController:search_concurso"});return e.json(m)}catch(s){let r=d({error:!0,code:400,message:JSON.stringify(s),data:{},path:"BetsController:search_concurso"});return e.json(r)}})}};var U=class{static addMoneyOnMatch(t){return n(this,null,function*(){var a,i,c;let[e]=yield p.query("SELECT * FROM VIEW_VERIFICAR_SE_EXISTE_PAGAMENTO_IN_PROCESSO;"),s=yield S.createPayment({transaction_amount:t,payment_method_id:"debit_card",payer:{email:"heuderdev@gmail.com"},installments:1});if(console.log(JSON.stringify(s,null,2)),((a=e[0])==null?void 0:a.id)!=null){let[m]=yield p.query("SELECT * FROM TB_ACUMULA_VALORES_CASO_AWARDS_DIFERENTE_IN_PROCESSING WHERE id = 1;"),l=Number((i=e[0])==null?void 0:i.subtract_premiums),_=l+t;console.log(Number((c=m[0])==null?void 0:c.amount)),console.log(l),console.log(_)}else console.log("RECURSO EM PROCESSO.");return{}})}};var P=class{static add(t,e){return n(this,null,function*(){let s=yield U.addMoneyOnMatch(1);return e.json(s)})}};var q=class{static checkPayment(t,e){return n(this,null,function*(){try{let s=Number(t.body.id),r=yield S.GetPayment(s),a=r.response.status_detail,i=r.response.status,[c]=yield p.query("UPDATE transactions AS T SET m_status= ?, m_status_detail=? WHERE m_id =? ",[i,a,s]);return e.json({id:r.response.transaction_details.transaction_id})}catch(s){return e.json({id:{},error:s})}})}static webhook(t,e){return n(this,null,function*(){})}};var x=class{static create(t,e,s,r,a,i,c,m,l,_){return n(this,null,function*(){try{let[u]=yield p.query("INSERT INTO adresses (cep, state, city, neighborhood, street, number, geographic_location, latitude, longitude, establishmentId) VALUES (?,?,?,?,?,?,?,?,?,?)",[t,e,s,r,a,i,c,m,l,_]);return d({path:"ADRESSESENTITIES::CREATE::TRY",data:{createdAdresses:u}})}catch(u){return d({error:!0,code:400,path:"ADRESSESENTITIES::CREATE::CATCH",data:{},message:JSON.stringify(u,null,2)})}})}};var v=class{static create(t,e){return n(this,null,function*(){var s;try{let{cep:r,state:a,city:i,neighborhood:c,street:m,number:l,geographic_location:_,latitude:u,longitude:b}=t.body,O=(s=t.user)==null?void 0:s.establishmentId;console.log(t.body,O);let I=yield x.create(r,a,i,c,m,l,_,u,b,O);return e.status(I.code).json(I)}catch(r){return e.status(400).json(r)}})}};var G=class{static create(t,e,s,r,a,i){return n(this,null,function*(){try{let[c]=yield p.query("INSERT INTO establishments (name, userId, seller_code, number_phone, number_code, description) VALUES (?,?,?,?,?,?)",[t,e,s,r,a,i]);return d({path:"ESTABLISHMENTSENTITIES::CREATE::TRY",data:{createdEstablishement:c}})}catch(c){return d({error:!0,code:400,path:"ESTABLISHMENTSENTITIES::CREATE::CATCH",data:{},message:JSON.stringify(c,null,2)})}})}};var D=class{static create(t,e){return n(this,null,function*(){try{let{name:s,userId:r,seller_code:a,number_phone:i,number_code:c,description:m}=t.body;console.log(`INSERT INTO establishments (name, userId, seller_code, number_phone, number_code, description) VALUES (${s}, ${r}, ${a}, ${i}, ${c}, ${m}) `);let l=yield G.create(s,r,a,i,c,m);return e.status(l.code).json(l)}catch(s){return e.status(400).json(s)}})}};var E=(0,et.Router)();E.post("/v1/users/signin",T.signIn);E.post("/v1/users/signup",T.signUp);E.get("/v1/games",h.index);E.post("/v1/games/create",y,h.create);E.post("/v1/bets",y,L.search_concurso);E.post("/v1/awards/add-money",P.add);E.post("/v1/verify-payment",y,q.checkPayment);E.post("/v1/adresses",y,v.create);E.post("/v1/establishment",y,D.create);var N=(0,H.default)();N.use(H.default.json());N.use((0,rt.default)());N.use((o,t,e)=>{o.io=at,t.header("Access-Control-Allow-Origin","*"),t.header("Access-Control-Allow-Methods","OPTIONS, GET, PUT, POST, DELETE, HEAD, PATH"),t.header("Access-Control-Allow-Headers","*"),e()});var nt=st.default.createServer(N),at=new ot.Server(nt,{cors:{origin:"*"}});at.on("connection",o=>{console.log("connection: ",o==null?void 0:o.id),o.on("{USUSERLOGGEDIN}",t=>{o.join(t)})});N.use(E);nt.listen(process.env.PORT||4007,"0.0.0.0",()=>{console.log(`server running... \u{1F431}\u200D\u{1F3CD} http://0.0.0.0:${process.env.PORT}`)});
